<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Courier, monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            /* height: 100vh; */
            margin: 0;
            padding-bottom: 40px;
        }

        .calculator {
            overflow-x: auto;
            /* Enable horizontal scrolling */
            max-width: 700px;
            width: 100%;
            /* Set your desired maximum width */
            display: flex;
            flex-direction: column;
            /* align-items: left; */
            /* justify-content: center; */
        }

        /* Target Microsoft Edge on iOS */
        /* Responsive design for all browsers and devices */

        .button-label {
            display: inline-block;
            margin-top: 5px;
            font-family: Courier, monospace;
            font-size: 15px;
            /* Remove background color */
            border: none;
            /* max-width: 200px; */
        }

        .input-text {
            width: 95%;
            height: 80px;
            font-size: 16px;
            border: 2px solid orange;
            border-radius: 5px;
            resize: none;
            padding: 0px;
            resize: vertical;
            margin-left: 5px;
        }

        .input-field {
            margin-left: 5px;
            width: 80%;
            height: 120px;
            font-size: 16px;
            border: 2px solid orange;
            border-radius: 5px;
            /* resize: none; */
            padding: 5px;
            /* margin-bottom: 20px; */
            overflow: auto;
            white-space: pre;
            line-height: 1.5;
            resize: vertical;
        }

        .output {
            /* width: 95%; */
            text-align: left;
            margin-right: 10px;
        }

        .sub-text {
            color: orange;
            padding-top: 0px;
            padding-bottom: 5px;
        }

        .table-wrapper {
            display: flex;
            justify-content: center;
        }

        table {
            border-collapse: collapse;
            margin-top: 20px;
            border: 1px solid transparent;
        }

        th,
        td {
            border: 1px solid transparent;
            text-align: left;
        }

        th {
            background-color: transparent;
            vertical-align: top;
        }

        td {
            background-color: transparent;
        }

        /* Red color for the highlighted bits */

        .highlight {
            color: red;
            font-weight: bold;
        }

        /*New added*/
        /* CSS code */
        /* table tr td:first-child, */

        table tr th:first-child {
            width: 20%;
        }

        .binHeader {
            padding-top: 2;
            padding-bottom: 0;
            border: 1px solid transparent;
        }

        .bit {
            width: fit-content;
            padding: 0;
            padding-top: 2px;
            border: 1px solid transparent;
            border-top: 1px dashed black;
            text-align: center;
        }

        .group {
            padding: 0;
            border-left: 2px solid black;
            border-right: 2px solid black;
            text-align: center;
            font-size: 14px;
            width: fit-content;
        }

        .field_value {
            color: violet;
            text-align: center;
            font-weight: bold;
        }

        .fieldInfo {
            padding: 0;
            padding-top: 2px;
            border-top: 1px solid black;
            border-bottom: 1px dashed black;
            border-left: 2px solid black;
            border-right: 2px solid black;
            text-align: center;
            vertical-align: top;
            font-size: 12px;
        }

        .bitPosition {
            height: 10px;
            text-align: left;
            font-size: 10px;
            color: orange;
            padding: 0;
            width: fit-content;
            /* border-left: 2px solid black;
            border-right: 2px solid black; */
            /* text-align: left; */
        }

        .popup-text {
            width: 100%;
            height: 90%;
            font-size: 16px;
            border: 2px solid orange;
            border-radius: 5px;
            /* resize: none; */
            padding: 5px;
            margin-bottom: 5px;
            vertical-align: top;
            text-align: left;
            /* margin-bottom: 20px; */
            overflow: auto;
            white-space: pre-line;
            line-height: 1.5;
        }

        .popup-form {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #f2f2f2;
            padding: 20px;
            padding-bottom: 40px;
            border: 1px solid #ccc;
            /* z-index: 1; */
            max-width: 700px;
            height: 500px;
            text-align: center;
            vertical-align: top;
            /* Use flexbox */
            flex-direction: column;
            /* Stack items vertically */
            align-items: flex-start;
        }

        .highlighted-line {
            background-color: yellow;
            /* Change this to the desired highlight color */
        }
    </style>
</head>

<body onkeydown="handleEnter(event)">
    <div class="calculator">
        <h1 style="text-align: center;">Calculator</h1>
        <!-- Header -->
        <textarea id="input_expression" rows="1" class="input-text">0</textarea>
        <div style="width: 100%;"><button class="button-label" onclick="calculateSum();">Expression</button></div>

        <div style="padding: 8px;"></div>
        <div style="display: flex; align-items: center;width: 100%;">

            <div id="input_field" rows="1" style="margin-right: 5px;flex: 1;width: 100%;" class="input-field"
                contenteditable="true"></div>
            <div style="display: flex; flex-direction: column;">

                <button
                    style="margin:5px; padding: 5px 10px; background-color:blue; color: #fff; border: none; cursor: pointer;"
                    onclick="showPopupForm('C_Header')">.h</button>
                <button
                    style="margin: 5px; padding: 5px 10px; background-color: blue; color: #fff; border: none; cursor: pointer;"
                    onclick="showPopupForm('SV_Header')">.sv</button>
                <button
                    style="margin: 5px; padding: 5px 10px; background-color: blue; color: #fff; border: none; cursor: pointer;"
                    onclick="showPopupForm('Spec')">Spec</button>

            </div>
        </div>
        <button class="button-label" onclick="calculateSum();">Fields</button>

        <div class="output">
            <table>
                <tr>
                    <th>Decimal</th>
                    <td id="decimalResult">0</td>
                </tr>
                <tr>
                    <th>Hexadecimal</th>
                    <td id="hexResult">0x0000_0000_0000_0000</td>

            </table>
            <table id="binary-table">
                <tr id="fields63_32">
                </tr>
                <tr>
                    <th class="binHeader">Binary</th>
                    <td id="bit63" class="bit" style="border-left: 2px solid black;">0</td>
                    <td id="bit62" class="bit">0</td>
                    <td id="bit61" class="bit">0</td>
                    <td id="bit60" class="bit">0</td>
                    <td id="bit59" class="bit">0</td>
                    <td id="bit58" class="bit">0</td>
                    <td id="bit57" class="bit">0</td>
                    <td id="bit56" class="bit" style="border-right: 2px solid black;">0</td>
                    <td id="bit55" class="bit">0</td>
                    <td id="bit54" class="bit">0</td>
                    <td id="bit53" class="bit">0</td>
                    <td id="bit52" class="bit">0</td>
                    <td id="bit51" class="bit">0</td>
                    <td id="bit50" class="bit">0</td>
                    <td id="bit49" class="bit">0</td>
                    <td id="bit48" class="bit" style="border-right: 2px solid black;">0</td>
                    <td id="bit47" class="bit">0</td>
                    <td id="bit46" class="bit">0</td>
                    <td id="bit45" class="bit">0</td>
                    <td id="bit44" class="bit">0</td>
                    <td id="bit43" class="bit">0</td>
                    <td id="bit42" class="bit">0</td>
                    <td id="bit41" class="bit">0</td>
                    <td id="bit40" class="bit" style="border-right: 2px solid black;">0</td>
                    <td id="bit39" class="bit">0</td>
                    <td id="bit38" class="bit">0</td>
                    <td id="bit37" class="bit">0</td>
                    <td id="bit36" class="bit">0</td>
                    <td id="bit35" class="bit">0</td>
                    <td id="bit34" class="bit">0</td>
                    <td id="bit33" class="bit">0</td>
                    <td id="bit32" class="bit" style="border-right: 2px solid black;">0</td>
                </tr>
                <tr>
                    <th></th>
                    <td colspan="7" style="border-left: 2px solid black;" class="bitPosition">63</td>
                    <td colspan="1" style="border-right: 2px solid black;" class="bitPosition">56</td>
                    <td colspan="7" style="border-left: 2px solid black;" class="bitPosition">55</td>
                    <td colspan="1" style="border-right: 2px solid black;" class="bitPosition">48</td>
                    <td colspan="7" style="border-left: 2px solid black;" class="bitPosition">47</td>
                    <td colspan="1" style="border-right: 2px solid black;" class="bitPosition">42</td>
                    <td colspan="7" style="border-left: 2px solid black;" class="bitPosition">41</td>
                    <td colspan="1" style="border-right: 2px solid black;" class="bitPosition">32</td>
                </tr>
                <tr>
                    <th></th>
                    <td colspan="8" class="group">Byte7</td>
                    <td colspan="8" class="group">Byte6</td>
                    <td colspan="8" class="group">Byte5</td>
                    <td colspan="8" class="group">Byte4</td>
                </tr>
                <tr>
                    <!-- <td colspan="2" style="height: 20px;"> </td> -->
                    <td style="height: 20px"></td>
                </tr>
                <tr id="fields31_0">
                    <th class="binHeader"></th>
                </tr>
                <tr>
                    <th class="binHeader"></th>
                    <td id="bit31" class="bit" style="border-left: 2px solid black;">0</td>
                    <td id="bit30" class="bit">0</td>
                    <td id="bit29" class="bit">0</td>
                    <td id="bit28" class="bit">0</td>
                    <td id="bit27" class="bit">0</td>
                    <td id="bit26" class="bit">0</td>
                    <td id="bit25" class="bit">0</td>
                    <td id="bit24" class="bit" style="border-right: 2px solid black;">0</td>
                    <td id="bit23" class="bit">0</td>
                    <td id="bit22" class="bit">0</td>
                    <td id="bit21" class="bit">0</td>
                    <td id="bit20" class="bit">0</td>
                    <td id="bit19" class="bit">0</td>
                    <td id="bit18" class="bit">0</td>
                    <td id="bit17" class="bit">0</td>
                    <td id="bit16" class="bit" style="border-right: 2px solid black;">0</td>
                    <td id="bit15" class="bit">0</td>
                    <td id="bit14" class="bit">0</td>
                    <td id="bit13" class="bit">0</td>
                    <td id="bit12" class="bit">0</td>
                    <td id="bit11" class="bit">0</td>
                    <td id="bit10" class="bit">0</td>
                    <td id="bit9" class="bit">0</td>
                    <td id="bit8" class="bit" style="border-right: 2px solid black;">0</td>
                    <td id="bit7" class="bit">0</td>
                    <td id="bit6" class="bit">0</td>
                    <td id="bit5" class="bit">0</td>
                    <td id="bit4" class="bit">0</td>
                    <td id="bit3" class="bit">0</td>
                    <td id="bit2" class="bit">0</td>
                    <td id="bit1" class="bit">0</td>
                    <td id="bit0" class="bit" style="border-right: 2px solid black;">0</td>
                </tr>
                <tr>
                    <th></th>
                    <td colspan="7" style="border-left: 2px solid black;" class="bitPosition">31</td>
                    <td colspan="1" style="border-right: 2px solid black;" class="bitPosition">24</td>
                    <td colspan="7" style="border-left: 2px solid black;" class="bitPosition">23</td>
                    <td colspan="1" style="border-right: 2px solid black;" class="bitPosition">16</td>
                    <td colspan="7" style="border-left: 2px solid black;" class="bitPosition">15</td>
                    <td colspan="1" style="border-right: 2px solid black;" class="bitPosition">8</td>
                    <td colspan="7" style="border-left: 2px solid black;" class="bitPosition">7</td>
                    <td colspan="1" style="border-right: 2px solid black;" class="bitPosition">0</td>
                </tr>
                <tr>
                    <th></th>
                    <td colspan="8" class="group">Byte3</td>
                    <td colspan="8" class="group">Byte2</td>
                    <td colspan="8" class="group">Byte1</td>
                    <td colspan="8" class="group">Byte0</td>
                </tr>
                <tr>
                    <td style="height: 20px"></td>
                </tr>
            </table>
        </div>
    </div>
    <div class="popup-form" id="popupForm" style="align-items: center;">
        <label for="form_text_output" id="popupFormLabel"></label>
        <div id="form_text_output" class="popup-text" placeholder="Enter text"></div>
        <button onclick="closeForm()">Done</button>
    </div>
    <script>
        displayPageName();
        if (!/iPhone|iPod|iPad|Android/.test(navigator.userAgent)) {
            dragForm();
            highlightFields();
        } else {
            const inputElement = document.getElementById('input_expression');
            const fieldElement = document.getElementById('input_field');
            inputElement.addEventListener("blur", function () {
                calculateSum();
            });
            fieldElement.addEventListener("blur", function () {
                calculateSum();
            });
        }

        function displayPageName() {
            document.addEventListener("DOMContentLoaded", function () {
                var pageTitle = String.fromCharCode(
                    67, 97, 108, 99, 117, 108, 97, 116, 111, 114, 32, 40, 67, 114, 101, 97, 116, 101, 100, 32, 98, 121, 32,
                    78, 103, 117, 121, 101, 110, 32, 84, 111, 110, 41
                );
                document.title = pageTitle;
            });
        }

        function highlightFields() {
            const textOutput = document.getElementById("input_field");

            textOutput.addEventListener("mousemove", highlightLine);

            function highlightAndGetBitfield(fieldId) {
                const allElements = document.querySelectorAll(`[id="${fieldId}"]`);
                let fieldVal = ""
                allElements.forEach((ele, idx) => {
                    ele.style.backgroundColor = 'yellow';
                    fieldVal = ele.innerText;
                });
                return fieldVal;
            }

            function deemphasizeBitfield(fieldId) {
                const allElements = document.querySelectorAll(`[id="${fieldId}"]`);
                allElements.forEach((ele, idx) => {
                    ele.style.backgroundColor = '';
                });

            }



            function highlightLine(event) {
                function getCurrentCursorLineIndex() {
                    const selection = window.getSelection();
                    if (selection && selection.anchorNode) {
                        const cursorLine = selection.anchorNode.parentElement;
                        return Array.from(cursorLine.parentElement.children).indexOf(cursorLine);
                    }
                    return -1;
                }
                const lineHeight = parseFloat(getComputedStyle(textOutput).lineHeight);
                const mouseY = event.clientY + textOutput.scrollTop - textOutput.getBoundingClientRect().top;
                const hoveredLineIndex = Math.floor(mouseY / lineHeight);
                const currentScrollTop = textOutput.scrollTop;
                const cursorIndex = getCurrentCursorLineIndex();
                const cursorOffset = window.getSelection().focusOffset;
                const lines = textOutput.innerText.split('\n');
                textOutput.innerHTML = lines.map((line, index) => {
                    if (index === hoveredLineIndex) {
                        const fieldVal = highlightAndGetBitfield(`BitField${index}`);
                        return `<div class="highlighted-line" title="${fieldVal}"">${line}</div>`;
                    } else {
                        deemphasizeBitfield(`BitField${index}`);
                        return `<div>${line}</div>`;
                    }
                }).join('');
                // Restore the scroll position
                textOutput.scrollTop = currentScrollTop;

                // Restore the cursor position within the hovered line
                const restoredLine = lines[cursorIndex];
                if (restoredLine && cursorOffset <= restoredLine.length) {
                    const newRange = document.createRange();
                    const newSelection = window.getSelection();
                    newRange.setStart(textOutput.childNodes[cursorIndex].firstChild, cursorOffset);
                    newSelection.removeAllRanges();
                    newSelection.addRange(newRange);
                }

            }
        }

        function dragForm() {
            let offsetX = 0;
            let offsetY = 0;
            let isDragging = false;

            const popupForm = document.getElementById("popupForm");

            popupForm.addEventListener("mousedown", (e) => {
                if (e.target === popupForm) {
                    isDragging = true;
                    const rect = popupForm.getBoundingClientRect();
                    offsetX = e.clientX - (rect.left + rect.right) / 2;
                    offsetY = e.clientY - (rect.top + rect.bottom) / 2;
                }
            });

            document.addEventListener("mousemove", (e) => {
                if (isDragging) {
                    const newX = e.clientX - offsetX;
                    const newY = e.clientY - offsetY;
                    popupForm.style.left = `${newX}px`;
                    popupForm.style.top = `${newY}px`;
                }
            });

            document.addEventListener("mouseup", () => {
                isDragging = false;
            });

        }


        function showPopupForm(input) {
            const popupForm = document.getElementById("popupForm");
            popupForm.style.display = "block";
            const inputField = popupForm.querySelector("#form_text_output");
            // inputField.value = "abcded";
            const myfieldDict = getFields();
            let content = ""
            const labelElement = document.getElementById("popupFormLabel");
            const keyList = Object.keys(myfieldDict).sort((a, b) => a - b);
            const maxFieldNameLen = Object.values(myfieldDict).reduce((max, item) => Math.max(max, item.fieldName.length), 0);
            if (input == "C_Header") {
                labelElement.textContent = "Convert To C header";
                content = "#pragma pack(1)\ntypedef struct {\n";
                for (const key of keyList) {
                    const msb = parseInt(key);
                    const lsb = parseInt(myfieldDict[key]['lsbPos']);
                    const size = msb - lsb + 1;
                    const fieldName = myfieldDict[key]['fieldName'].replace(/\s+/g, "");
                    content += ` uint32_t ${fieldName} : ${size};`.padEnd(maxFieldNameLen + 20);
                    content += (lsb != msb) ? `// bit${lsb}->${msb}\n` : `// bit${lsb}\n`;

                }
                content += `}Object_t;\n`;
            } else if (input == "SV_Header") {
                labelElement.textContent = "Convert To SV header";
                content = "typedef struct packed{\n";
                for (const key of Object.keys(myfieldDict).sort((a, b) => b - a)) {
                    const msb = parseInt(key);
                    const lsb = parseInt(myfieldDict[key]['lsbPos']);
                    const size = msb - lsb + 1;
                    const fieldName = myfieldDict[key]['fieldName'].replace(/\s+/g, "");
                    let fieldDeclare = (size == 1) ? "bit" : `bit [${size - 1}:0]`;
                    fieldDeclare = fieldDeclare.padEnd(11);
                    fieldDeclare += `${fieldName};`;
                    content += fieldDeclare.padEnd(maxFieldNameLen + 20);
                    content += (lsb != msb) ? `// bit${lsb}->${msb}\n` : `// bit${lsb}\n`;

                }
                content += `}Object_s;\n`;
            } else if (input == "Spec") {
                labelElement.textContent = "Convert To Specification";
                content = `BitIndex`.padEnd(10) + `|Register Description\n`;
                content += '-'.repeat(10) + '+' + '-'.repeat(40) + "\n";
                for (const key of Object.keys(myfieldDict).sort((a, b) => a - b)) {
                    const msb = parseInt(key);
                    const lsb = parseInt(myfieldDict[key]['lsbPos']);
                    const size = msb - lsb + 1;
                    const fieldName = myfieldDict[key]['fieldName'];
                    let fieldDeclare = (size == 1) ? `${msb}` : `${msb}:${lsb}`;
                    content += fieldDeclare.padEnd(10);
                    content += `|${fieldName}\n`;

                }

            }
            // Replace semicolon with HTML entity &semi;
            content = content.replace(/\;/g, "&semi;");
            content = content.replace(/  /g, " &nbsp;");
            inputField.innerHTML = content;
        }

        function closeForm() {
            var popupForm = document.getElementById("popupForm");

            popupForm.style.display = "none";
        }

        function handleEnter(event) {
            if ((event.target.id !== "input_field") &&
                (event.key === 'Enter')) {
                // if (event.key === 'Enter') {
                calculateSum();
                event.preventDefault();
            }
        }

        function decimalToHex(decimal) {
            const arr = new BigUint64Array(1);
            arr[0] = BigInt(decimal);
            return Array.from(new Uint8Array(arr.buffer)).map(b => b.toString(16).padStart(2, '0')).reverse().join('').toUpperCase();
        }

        function decimalToBinary(decimal) {
            const arr = new BigUint64Array(1);
            arr[0] = BigInt(decimal);
            return Array.from(new Uint8Array(arr.buffer)).map(b => b.toString(2).padStart(8, '0')).reverse().join('').toUpperCase();
        }

        function convertInput(inputVal) {
            function isHexString(str) {
                return /^[0-9A-Fa-f\s]+$/.test(str);
            }

            function convertToLittleEndian(inputHexString) {
                const hexString = inputHexString.trim();
                if ((!hexString.startsWith("{") || !hexString.endsWith("}")) &&
                    (!hexString.startsWith("[") || !hexString.endsWith("]"))
                ) {
                    return null; // Invalid format
                }

                const hexValues = inputHexString.replace(/\s/g, "").slice(1, -1).split(",");
                if (hexValues.length === 0) {
                    return null; // No values inside the braces
                }

                const validHexValues = hexValues.filter(isHexString);
                if (validHexValues.length !== hexValues.length) {
                    return null; // Not all values are valid hex strings
                }
                const littleEndianNumber = "0x" + validHexValues.slice().reverse().join('');

                return littleEndianNumber;
            }
            const convert2LE = convertToLittleEndian(inputVal);
            if (convert2LE != null) return convert2LE;
            let convertVal = inputVal;

            const hexPattern = /[0-9]*'h([0-9A-Fa-f]+)/g;
            const binaryPattern = /[0-9]*'b([0-1]+)/g;
            const dashPattern = /([0-9])_([0-9])/g;
            const kBPattern = /([0-9])\s*k[b]*/ig;
            const mBPattern = /([0-9])\s*m[b]*/ig;
            const gBPattern = /([0-9])\s*g[b]*/ig;
            const tBPattern = /([0-9])\s*t[b]*/ig;
            const removeOctPattern = /([\+\-\*\/\^\&\~\%\<\>\(]\s*)[0]+([1-9])/ig;
            const removeOctFirstPattern = /^[0]+([1-9])/i;
            const removeSpace = /\s/g;
            convertVal = convertVal.replace(hexPattern, (_, e1) => '0x' + e1);
            convertVal = convertVal.replace(binaryPattern, (_, e1) => '0b' + e1);
            convertVal = convertVal.replace(dashPattern, (_, e1, e2) => e1 + e2);
            convertVal = convertVal.replace(kBPattern, (_, e1) => e1 + `*${1 << 10}`);
            convertVal = convertVal.replace(mBPattern, (_, e1) => e1 + `*${1 << 20}`);
            convertVal = convertVal.replace(gBPattern, (_, e1) => e1 + `*${1 << 30}`);
            convertVal = convertVal.replace(tBPattern, (_, e1) => e1 + `*${1 << 40}`);
            convertVal = convertVal.replace(removeOctPattern, (_, e1, e2) => e1 + e2);
            convertVal = convertVal.replace(removeOctFirstPattern, (_, e1) => e1);
            convertVal = convertVal.replace(/\s/g, "");
            return convertVal;
        }

        function highlightBit1InBinary(binary_str) {
            // Highlight bit 1 with red color
            let binaryHighlight = '';
            for (let i = 0; i <= 31; i++) {
                const bit = binary_str[i];
                binaryHighlight += bit === '1' ? `<span class="highlight">${bit}</span>` : bit;
                if ((i + 1) % 8 === 0 && i !== 31) {
                    binaryHighlight += ' '; // Add space every 4 bits (except the last group)
                } else if ((i + 1) % 4 === 0 && i !== 31) {
                    binaryHighlight += '_'; // Add space every 4 bits (except the last group)
                }
            }
            return binaryHighlight;
        }

        function updateBitVal(bitID, val) {
            const bitElement = document.getElementById(bitID);
            bitElement.innerHTML = val == 1 ? `<span class="highlight">${val}</span>` : val;
        }

        function removeFields() {
            let fieldsRow = document.getElementById("fields63_32");
            // Remove all existing td elements from the row
            while (fieldsRow.firstChild) {
                fieldsRow.removeChild(fieldsRow.firstChild);
            }
            fieldsRow.appendChild(document.createElement("th"));
            fieldsRow = document.getElementById("fields31_0");
            // Remove all existing td elements from the row
            while (fieldsRow.firstChild) {
                fieldsRow.removeChild(fieldsRow.firstChild);
            }
            fieldsRow.appendChild(document.createElement("th"));
        }

        function addFields(msb, lsb, str64bit, fieldName, idx) {
            const reverseStr64bit = str64bit.split("").reverse().join("");
            const substringBinary = reverseStr64bit.substring(lsb, msb + 1).split("").reverse().join("");
            const hexadecimalValue = parseInt(substringBinary, 2).toString(16);
            let fieldsRow = "";
            let fieldSize = 0;
            let newTd = document.createElement("td");
            const fieldContent = `${fieldName}<br><span class="field_value">${hexadecimalValue}</span>`;
            if ((msb <= 31) && (lsb <= 31)) {
                fieldsRow = document.getElementById("fields31_0");
                fieldSize = msb - lsb + 1;
                newTd.setAttribute("colspan", fieldSize);
                newTd.className = "fieldInfo";
                newTd.id = `BitField${idx}`;
                newTd.innerHTML = fieldContent;
                fieldsRow.appendChild(newTd);
            } else if ((msb >= 32) && (lsb >= 32)) {
                fieldsRow = document.getElementById("fields63_32");
                fieldSize = msb - lsb + 1;
                newTd.setAttribute("colspan", fieldSize);
                newTd.className = "fieldInfo";
                newTd.id = `BitField${idx}`;
                newTd.innerHTML = fieldContent;
                fieldsRow.appendChild(newTd);
            } else {
                fieldsRow = document.getElementById("fields63_32");
                fieldSize = msb - 32 + 1;
                newTd.setAttribute("colspan", fieldSize);
                newTd.className = "fieldInfo";
                newTd.id = `BitField${idx}`;
                newTd.innerHTML = fieldContent;
                fieldsRow.appendChild(newTd);

                newTd = document.createElement("td");
                fieldsRow = document.getElementById("fields31_0");
                fieldSize = 31 - lsb + 1;
                newTd.setAttribute("colspan", fieldSize);
                newTd.className = "fieldInfo";
                newTd.id = `BitField${idx}`;
                newTd.innerHTML = fieldContent;
                fieldsRow.appendChild(newTd);

            }

        }

        function getFields() {
            const inputElement = document.getElementById('input_field');
            inputVal = inputElement.innerText;
            const myfieldDict = {};
            let idxCnt;
            inputVal.split(/\n/).forEach((text, idx) => {
                text = text.replace(/\s+[-:]\s+\w[^;]+$/, ""); //Remove comment
                let regex = /^\s*(\d+)\s*[:-]\s*(\d+)[\s\|]+(.*)/;
                if (regex.test(text)) {
                    const val1 = parseInt(RegExp.$1);
                    const val2 = parseInt(RegExp.$2);
                    const fieldName = RegExp.$3.replace(/[-]+/g, "_");
                    const msbVal = Math.max(val1, val2);
                    const lsbPos = Math.min(val1, val2);
                    myfieldDict[msbVal] = {};
                    myfieldDict[msbVal]["lsbPos"] = lsbPos;
                    myfieldDict[msbVal]["fieldName"] = fieldName;
                    myfieldDict[msbVal]["idx"] = idx;
                    return;
                }
                regex = /^\s*(\d+)[\s|]+([\w ]+)\b/;
                if (regex.test(text)) {
                    const val1 = parseInt(RegExp.$1);
                    const fieldName = RegExp.$2;
                    myfieldDict[val1] = {};
                    myfieldDict[val1]["lsbPos"] = val1;
                    myfieldDict[val1]["fieldName"] = fieldName;
                    myfieldDict[val1]["idx"] = idx;
                    return;

                }
                regex = /(\bchar\b|\buint8_t\b|\bsigned char\b|\bint8_t\b|\bunsigned short\b|\buint16_t\b|\bshort\b|\bint16_t\b|\bunsigned int\b|\buint32_t\b|\bint\b|\bint32_t\b|\bunsigned long long\b|\buint64_t\b|\blong long\b|\bint64_t\b)\s+(\w+)\s*:\s*(\d+)\s*/;
                if (regex.test(text)) {
                    if (typeof idxCnt === "undefined") idxCnt = 0;
                    const lsbPos = idxCnt;
                    const size = parseInt(RegExp.$3);
                    const msbVal = lsbPos + size - 1;
                    const fieldName = RegExp.$2;
                    myfieldDict[msbVal] = {};
                    myfieldDict[msbVal]["lsbPos"] = lsbPos;
                    myfieldDict[msbVal]["fieldName"] = fieldName;
                    myfieldDict[msbVal]["idx"] = idx;
                    idxCnt += size;
                    return;

                }
                regex = /(\bbit\b|\breg\b|\blogic\b)\s*\[\s*(\d+)\s*:(\d+)\s*\]\s*(\w+)\s*/;
                if (regex.test(text)) {
                    if (typeof idxCnt === "undefined") idxCnt = 0;
                    const size = Math.abs(parseInt(RegExp.$3) - parseInt(RegExp.$2)) + 1;
                    const lsbPos = idxCnt - size;
                    const msbVal = lsbPos + size - 1;
                    const fieldName = RegExp.$4;
                    myfieldDict[msbVal] = {};
                    myfieldDict[msbVal]["lsbPos"] = lsbPos;
                    myfieldDict[msbVal]["fieldName"] = fieldName;
                    myfieldDict[msbVal]["idx"] = idx;
                    idxCnt -= size;
                    return;

                }
                regex = /^\s*(\bbit\b|\breg\b|\blogic\b|\bbyte\b|\bshortint\b|\bint\b|\blongint\b|\binteger\b)\s+(\w+)\s*/;
                if (regex.test(text)) {
                    if (typeof idxCnt === "undefined") idxCnt = 0;

                    const numType = RegExp.$1;
                    const size = (numType.includes("bit") || numType.includes("logic") || numType.includes("reg")) ? 1 : (
                        numType.includes("byte") ? 8 : (
                            numType.includes("shortint") ? 16 : (
                                numType.includes("longint") ? 64 : 32
                            )
                        )
                    );
                    const lsbPos = idxCnt - size;
                    const msbVal = lsbPos + size - 1;
                    const fieldName = RegExp.$2;
                    myfieldDict[msbVal] = {};
                    myfieldDict[msbVal]["lsbPos"] = lsbPos;
                    myfieldDict[msbVal]["fieldName"] = fieldName;
                    myfieldDict[msbVal]["idx"] = idx;
                    idxCnt -= size;
                    return;

                }
            })
            if (idxCnt < 0) {
                const offset = Math.abs(idxCnt);
                const keyLst = Object.keys(myfieldDict);
                for (const key of keyLst) {
                    const newKey = parseInt(key) + offset;
                    myfieldDict[key]['lsbPos'] += offset;
                    myfieldDict[newKey] = myfieldDict[key];
                    delete myfieldDict[key];
                }
            }
            let maxCheckedVal = 63;
            let rsvCnt = 0;
            const msbLst = Object.keys(myfieldDict).sort((a, b) => b - a);
            if (msbLst.length == 0) return myfieldDict;
            let idx = -1;
            let lsbPos = 0;
            while (maxCheckedVal >= 0) {

                if (myfieldDict.hasOwnProperty(maxCheckedVal) == 0) {
                    lsbPos = (idx <= msbLst.length - 2) ? parseInt(msbLst[idx + 1]) + 1 : 0;
                    myfieldDict[maxCheckedVal] = {};
                    myfieldDict[maxCheckedVal]['lsbPos'] = parseInt(lsbPos);
                    myfieldDict[maxCheckedVal]['fieldName'] = `RSV${rsvCnt}`;
                    rsvCnt++;
                } else {
                    lsbPos = myfieldDict[maxCheckedVal]['lsbPos'];
                    idx++;
                }
                maxCheckedVal = parseInt(lsbPos) - 1;

            }

            return myfieldDict;
        }




        function calculateSum() {
            let inputVal = '';
            try {
                const inputElement = document.getElementById('input_expression');
                if (!inputElement) {
                    alert('Error: Input element not found');
                    return;
                }
                inputVal = inputElement.value.replace(/_/g, ''); // Remove underscores
                // Convert custom syntax like bit(n) to (1 << n)
                inputVal = inputVal.replace(/bit\((\d+)\)/g, '(1 << $1)');
                // Convert numbers to BigInt-safe operations and handle shifts
                inputVal = inputVal.replace(/0x[0-9A-Fa-f]+|\d+|>>|<</g, (match) => {
                    if (match.startsWith('0x')) {
                        let hexValue = match.slice(2).padStart(16, '0'); // Ensure 16 hex digits
                        let high = parseInt(hexValue.slice(0, 8), 16);
                        let low = parseInt(hexValue.slice(8, 16), 16);
                        return `(BigInt(${high}) << 32n | BigInt(${low}))`;
                    } else if (match === '>>') {
                        return '>>';
                    } else if (match === '<<') {
                        return '<<';
                    } else {
                        return `BigInt(${match})`;
                    }
                });

                console.log("Evaluating: ", inputVal);
                // Evaluate the modified expression safely
                const result = eval(inputVal);
                console.log("Result: ", result);

                // Convert result back to 64-bit hex
                let resultHigh = Number((result >> 32n) & 0xFFFFFFFFn);
                let resultLow = Number(result & 0xFFFFFFFFn);

                const decimalResultElement = document.getElementById('decimalResult');
                if (decimalResultElement) {
                    decimalResultElement.textContent = `${result.toLocaleString()}`;
                } else {
                    console.error("Element with ID 'decimalResult' not found in the DOM.");
                }

                const hexResultElement = document.getElementById('hexResult');
                if (hexResultElement) {
                    // const hexStr = result.toString(16).padStart(16, '0').match(/.{1,4}/g).join('_');
                    const hexStr = result.toString(16).padStart(16, '0').replace(/(?<=\w)(?=(\w{4})+$)/g, '_');
                    hexResultElement.textContent = `0x${hexStr}`;
                } else {
                    console.error("Element with ID 'hexResult' not found in the DOM.");
                }

                const binaryStr = result.toString(2).padStart(64, '0');
                binaryStr.split('').reverse().map((val, idex) => {
                    const bitElement = document.getElementById(`bit${idex}`);
                    if (bitElement) {
                        updateBitVal(`bit${idex}`, val);
                    } else {
                        console.warn(`Element with ID 'bit${idex}' not found in the DOM.`);
                    }
                });

                removeFields();
                myfieldDict = getFields();
                for (const key of Object.keys(myfieldDict).sort((a, b) => b - a)) {
                    const msb = key;
                    const lsb = myfieldDict[key]['lsbPos'];
                    const fieldName = myfieldDict[key]['fieldName'];
                    const idx = myfieldDict[key]['idx'];
                    addFields(parseInt(msb), parseInt(lsb), binaryStr, fieldName, idx);
                }
            } catch (error) {
                alert(`Error:  ${error}\nInput: ${inputVal}`);
            }
        }





    </script>
</body>

</html>
